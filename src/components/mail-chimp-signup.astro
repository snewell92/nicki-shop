---
---
<div id="mc_embed_signup" class="max-w-[65vw] w-fit mx-auto">
  <!-- can use the edge function to control te ux more if the 403 from edge -> mailchimp is figured out -->
  <!-- <form action="/signup" method="post" name="mc-embedded-subscribe-form" id="signup-form" class="validate" novalidate> -->
  <form action="https://wytchelmgrotto.us20.list-manage.com/subscribe/post?u=ecff512b8567c67909af60ab5&amp;id=a372ec2ebe&amp;f_id=00297feaf0https://wytchelmgrotto.us20.list-manage.com/subscribe/post?u=ecff512b8567c67909af60ab5&amp;id=a372ec2ebe&amp;f_id=00297feaf0" method="post" name="mc-embedded-subscribe-form" id="signup-form" class="validate" novalidate>

    <div>
			<h2 class="text-2xl mb-6">Subscribe to my Newsletter ✍️</h2>

      <div class="form-control w-full max-w-xs">
        <label class="label" for="mce-EMAIL">
          <span class="label-text">Email Address</span>
          <span class="label-text-alt italic text-accent">required</span>
        </label>
        <input name="EMAIL" id="mce-EMAIL" required type="email" placeholder="your-email@here.please" class="input input-bordered w-full max-w-xs" />
      </div>

      <div class="form-control w-full max-w-xs">
        <label class="label" for="mce-FNAME">
          <span class="label-text">Name</span>
        </label>
        <input name="FNAME" id="mce-FNAME" type="text" value="" placeholder="Pidge" class="input input-bordered w-full max-w-xs" />
      </div>

			<div id="signup-responses" class="text-center max-w-xs my-2">
				<div id="error-response" class="hidden underline decoration-error text-xl mb-4"></div>
				<div id="success-response" class="hidden underline decoration-emerald-200 text-xl mb-4">✅ Successfully Subscribed!</div>
			</div>

			<div style="position: absolute; left: -5000px;" aria-hidden="true">
			  <input type="text" name="b_ecff512b8567c67909af60ab5_a372ec2ebe" tabindex="-1" value="">
			</div>

			<div>
				<div>
					<input type="submit" class="btn w-full btn-secondary text-white mb-4 mt-6 underline" value="Subscribe" name="subscribe" />
					<span id="loading-indicator" class="hidden btn btn-secondary btn-square loading"></span>
				</div>
			</div>
		</div>
	</form>
</div>

<script>
  const $formEl: HTMLFormElement = document.forms["mc-embedded-subscribe-form"];
  const $emailEl = $formEl.elements.EMAIL;
  const $nameEl = $formEl.elements.FNAME;
  const $submitEl = $formEl.elements.subscribe;

  const $errorResponseEl = window["error-response"];
  const $successResponseEl = window["success-response"];
  const $loaderEl = window["loading-indicator"];

  function setLoading() {
    $loaderEl.classList.remove("hidden");
    $emailEl.disabled = true;
    $nameEl.disabled = true;
  }

  function unsetLoading() {
    $loaderEl.classList.add("hidden");
    $emailEl.disabled = false;
    $nameEl.disabled = false;
  }

  function resetResponses() {
    $errorResponseEl.classList.add("hidden");
    $successResponseEl.classList.add("hidden");
  }

  function setSuccess() {
    $successResponseEl.classList.remove("hidden");
    $submitEl.disabled = true;
    $submitEl.classList.add("disabled");
  }

  function setError() {
    $errorResponseEl.innerText = "An error occured, you have not been subscribed";
    $errorResponseEl.classList.remove("hidden");

    setTimeout(resetResponses, 5000);
  }

  function checkEmail() {
    if (!$formEl.reportValidity()) {
      $submitEl.disabled = true;
      $submitEl.classList.add("disabled");
      return false;
    }

    $submitEl.disabled = false;
    $submitEl.classList.remove("disabled");

    return true;
  }

  function handleSubmit(event: SubmitEvent) {
    setLoading();
    // Use JS to submit manually to control UX

    if (!$formEl.reportValidity()) {
      unsetLoading();
      event.preventDefault();
      return false;
    }

    return true;
  }

  // small debounce function
  function debounce(fn: Function, debounceMs = 400) {
    let prev: number;
    return () => {
      if (prev) {
        clearTimeout(prev);
      }

      prev = setTimeout(fn, debounceMs);
    };
  }

  $formEl.onsubmit = handleSubmit;
  $emailEl.onblur = checkEmail;
  $emailEl.oninput = debounce(checkEmail);

  const url = new URL(window.location);
  const params = url.searchParams;
  const signupStatus = params.get("signup_status");

  if (signupStatus === "Subscribed") {
    setSuccess();
  } else if (signupStatus === "Error") {
    setError()
  }
</script>
